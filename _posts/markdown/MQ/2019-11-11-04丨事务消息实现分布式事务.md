---
layout:     post
title:      "MQ-04丨事务消息实现分布式事务"
date:       2019-11-11 17:59:11
author:     "jiefang"
header-style: text
tags:
    - MQ
---
# 04丨事务消息实现分布式事务
消息队列中的“事务”，主要解决的是消息生产者和消息消费者的数据一致性问题。
##  分布式事务
分布式事务就是要在分布式系统中的实现事务。在分布式系统中，在保证可用性和不严重牺牲性能的前提下，光是要实现数据的一致性就已经非常困难了，所以出现了很多“残血版”的一致性，比如顺序一致性、最终一致性等等。

事务消息适用的场景主要是那些需要异步更新数据，并且对数据实时性要求不太高的场景。
## 如何实现分布式事务
事务消息需要消息队列提供相应的功能才能实现，Kafka 和 RocketMQ 都提供了事务相关功能。
![消息队列实现分布式事务](https://s2.ax1x.com/2019/10/27/KyfUln.png)

首先，订单系统在消息队列上开启一个事务。然后订单系统给消息服务器发送一个“半消息”，这个半消息不是说消息内容不完整，它包含的内容就是完整的消息内容，半消息和普通消息的唯一区别是，在事务提交之前，对于消费者来说，这个消息是不可见的。

半消息发送成功后，订单系统就可以执行本地事务了，在订单库中创建一条订单记录，并提交订单库的数据库事务。然后根据本地事务的执行结果决定提交或者回滚事务消息。

如果订单创建成功，那就提交事务消息，购物车系统就可以消费到这条消息继续后续的流程。如果订单创建失败，那就回滚事务消息，购物车系统就不会收到这条消息。这样就基本实现了“要么都成功，要么都失败”的一致性要求。

第四步提交事务消息时失败了怎么办？
Kafka 的解决方案比较简单粗暴，**直接抛出异常，让用户自行处理**。

## RocketMQ 中的分布式事务实现
在 RocketMQ 中的事务实现中，增加了**事务反查的机制**来解决事务消息提交失败的问题。如果 Producer也就是订单系统，在提交或者回滚事务消息时发生网络异常，RocketMQ的 Broker 没有收到提交或者回滚的请求，Broker 会定期去 Producer 上反查这个事务对应的本地事务的状态，然后根据反查结果决定提交或者回滚这个事务。为了支撑这个事务反查机制，我们的业务代码需要实现一个反查本地事务状态的接口，告知RocketMQ 本地事务是成功还是失败。

![RocketMQ分布式事务](https://s2.ax1x.com/2019/10/27/KyfokD.png)