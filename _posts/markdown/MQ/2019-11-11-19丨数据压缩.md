---
layout:     post
title:      "MQ-19丨数据压缩"
date:       2019-11-11 18:06:51
author:     "jiefang"
header-style: text
tags:
    - MQ
---
# 19丨数据压缩
对于 Kafka 来说，使用数据压缩，提升了大概几十倍的吞吐量。
当然，在实际生产时，不太可能达到这么高的压缩率，但是合理地使用数据压缩，仍然可以做到提升数倍的吞吐量。

**数据压缩不仅能节省存储空间，还可以用于提升网络传输性能**。

## 什么情况适合使用数据压缩？
网络传输数据,对比：
- 不压缩直接传输需要的时间是： 传输未压缩数据的耗时。
- 使用数据压缩需要的时间是： 压缩耗时 + 传输压缩数据耗时 + 解压耗时。

压缩和解压的操作都是计算密集型的操作，非常耗费CPU资源。如果你的应用处理业务逻辑就需要耗费大量的CPU资源，就不太适合再进行压缩和解压。

如果你的系统的瓶颈是磁盘的 IO 性能，CPU 资源又很闲，这种情况就非常适
合在把数据写入磁盘前先进行压缩。

如果你的系统读写比严重不均衡，你还要考虑，每读一次数据就要解压一次是不是划
算。
**压缩本质是资源的置换，是一个时间换空间，或者说是 CPU资源换存储资源的游戏**。

## 应该选择什么压缩算法？
目前常用的压缩算法包括：ZIP，GZIP，SNAPPY，LZ4等等。

选择压缩算法的时候，主要需要考虑数据的压缩率和压缩耗时。一般来说，压缩率越高的算法，压缩耗时也越高。如果是对性能要求高的系统，可以选择压缩速度快的算法，比如 LZ4；如果需要更高的压缩比，可以考虑 GZIP 或者压缩率更高的 XZ 等算法。

## 如何选择合适的压缩分段？
在压缩时，给定的被压缩数据它必须有确定的长度，或者说，是有头有尾的，不能是一个无限的数据流，如果要对流数据进行压缩，那必须把流数据划分成多个帧，一帧一帧的分段压缩。

需要根据业务，选择合适的压缩分段，在压缩率、压缩速度和解压浪费之间找
到一个合适的平衡。

## Kafka 是如何处理消息压缩的？

- Kafka 是否开启压缩，这是可以配置，它也支持配置使用哪一种压缩算法。原因我们在上面说过，不同的业务场景是否需要开启压缩，选择哪种压缩算法是不能一概而论的。所以，Kafka 的设计者把这个选择权交给使用者。
- 在开启压缩时，Kafka选择一批消息一起压缩，每一个批消息就是一个压缩分段。使用者也可以通过参数来控制每批消息的大小。
- 在 Kafka 中，生产者生成一个批消息发给服务端，在服务端中是不会拆分
批消息的。那按照批来压缩，意味着，在服务端也不用对这批消息进行解压，可以整批直接存储，然后整批发送给消费者。最后，批消息由消费者进行解压。