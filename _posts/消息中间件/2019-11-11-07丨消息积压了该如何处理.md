---
layout:     post
title:      "07丨消息积压了该如何处理"
date:       2019-11-11 18:01:29
author:     "jiefang"
header-style: text
tags:
    - 消息中间件
---
# 07丨消息积压了该如何处理
## 优化性能来避免消息积压
在使用消息队列的系统中，对于性能的优化，主要体现在生产者和消费者这一收一发两部分
的业务逻辑中。对于绝大多数使用消息队列的业务来说，消息队列本身的处理能力要远大于业务系统的处理能力。主流消息队列的单个节点，消息收发的性能可以达到每秒钟处理几万至几十万条消息的水平，还可以通过水平扩展 Broker 的实例数成倍地提升处理能力。

而一般的业务系统需要处理的业务逻辑远比消息队列要复杂，单个节点每秒钟可以处理几百到几千次请求，已经可以算是性能非常好的了。

所以，对于消息队列的性能优化，我们更关注的是，**在消息的收发两端，我们的业务代码怎么和消息队列配合，达到一个最佳的性能**。

### 发送端性能优化
发送端业务代码的处理性能，实际上和消息队列的关系不大，因为一般发送端都是先执行自己的业务逻辑，最后再发送消息。**如果说，你的代码发送消息的性能上不去，你需要优先检查一下，是不是发消息之前的业务逻辑耗时太多导致的**。

对于发送消息的业务逻辑，只需要注意**设置合适的并发和批量大小**，就可以达到很好的发送性能。
 Producer 发送消息的过程，Producer 发消息给 Broker，Broker
收到消息后返回确认响应，包括步骤的耗时：
- 发送端准备数据、序列化消息、构造请求等逻辑的时间，也就是发送端在发送网络请求之前的耗时；
- 发送消息和返回响应在网络传输中的耗时；
- Broker 处理消息的时延。

### 消费端性能优化
使用消息队列的时候，大部分的性能问题都出现在消费端，如果消费的速度跟不上发送端生产消息的速度，就会造成消息积压。

在设计系统的时候，**一定要保证消费端的消费性能要高于生产端的发送性能，这
样的系统才能健康的持续运行**。

消费端的性能优化除了优化消费业务逻辑以外，也可以通过水平扩容，增加消费端的并发数来提升总体的消费性能。特别需要注意的一点是，**在扩容 Consumer 的实例数量的同时，必须同步扩容主题中的分区（也叫队列）数量，确保 Consumer 的实例数和分区数量是相等的**。如果Consumer的实例数量超过分区数量，这样的扩容实际上是没有效果的。原因我们之前讲过，因为对于消费者来说，在每个分区上实际上只能支持单线程消费。

## 消息积压了该如何处理？
能导致积压突然增加，最粗粒度的原因，只有两种：**要么是发送变快了，要么是消费变慢了**。

如果是单位时间发送的消息增多，比如说是赶上大促或者抢购，短时间内不太可能优化消费端的代码来提升消费性能，唯一的方法是通**过扩容消费端的实例数来提升总体的消费能力**。

如果短时间内没有足够的服务器资源进行扩容，没办法的办法是，**将系统降级，通过关闭一些不重要的业务，减少发送方发送的数据量**，最低限度让系统还能正常运转，服务一些重要业务。

如果通过监控发现，无论是发送消息的速度还是消费消息的速度和原来都没什么变化，这时候你需要检查一下你的消费端，是不是**消费失败导致的一条消息反复消费这种情况比较多，这种情况也会拖慢整个系统的消费速度**。

如果监控到消费变慢了，你需要检查你的消费实例，分析一下是什么原因导致消费变慢。优先检查一下日志是否有大量的消费错误，如果没有错误的话，可以通过打印堆栈信息，看一下你的消费线程是不是卡在什么地方不动了，比如触发了死锁或者卡在等待某些资源上了。