---
layout:     post
title:      "16丨缓存策略：如何使用缓存来减少磁盘IO"
date:       2019-11-11 18:05:16
author:     "jiefang"
header-style: text
tags:
    - 消息中间件
---
# 缓存策略：如何使用缓存来减少磁盘IO
使用内存作为缓存来加速应用程序的访问速度，是几乎所有高性能系统都会采用的方法。

缓存的思想很简单，就是把低速存储的数据，复制一份副本放到高速的存储中，用来加速数据的访问。

## 选择只读缓存还是读写缓存？
使用缓存，首先你就会面临选择读缓存还是读写缓存的问题。他们唯一的区别就是，在更新数据的时候，是否经过缓存。

Kafka 使用的 PageCache，它就是一个非常典型的读写缓存

### PageCache
操作系统会利用系统空闲的物理内存来给文件读写做缓存，这个缓存叫做 PageCache。应用程序在写文件的时候，操作系统会先把数据写入到 PageCache 中，数据在成功写到PageCache 之后，对于用户代码来说，写入就结束了。
然后，操作系统再异步地把数据更新到磁盘的文件中。应用程序在读文件的时候，操作系统也是先尝试从 PageCache中寻找数据，如果找到就直接返回数据，找不到会触发一个缺页中断，然后操作系统把数据从文件读取到PageCache中，再返回给应用程序。

在数据写到 PageCache 中后，它并不是同时就写到磁盘上了，这中间是有
一个延迟的。操作系统可以保证，即使是应用程序意外退出了，操作系统也会把这部分数据同步到磁盘上。但是，如果服务器突然掉电了，这部分数据就丢失了。

**读写缓存的这种设计，它天然就是不可靠的，是一种牺牲数据一致性换取性能
的设计**。

### 为什么 Kafka 可以使用 PageCache 来提升它的性能呢？
- 消息队列它的读写比例大致是1：1，因为，大部分我们用消息队列都是一收一发这
样使用。这种读写比例，只读缓存既无法给写加速，读的加速效果也有限，并不能提升多少性能。
- Kafka 它并不是只靠磁盘来保证数据的可靠性，它更依赖的是，在不同节点上的多副本来解决数据可靠性问题，这样即使某个服务器掉电丢失一部分文件内容，它也可以从其他节点上找到正确的数据，不会丢消息。
- PageCache 这个读写缓存是操作系统实现的，Kafka 只要按照正确的姿势来使用就
好了，不涉及到实现复杂度的问题。

## 缓存更新策略
- 更新数据的同时去更新缓存
- 是定期来更新全部缓存
- 给缓存中的每个数据设置一个有效期，让它自然过期以达到更新的目的

## 缓存置换策略
最经典也是最实用的算法就是 LRU 算法，也叫最近最少使用算法。LRU 的算法原理非常简单，它总是把最长时间未被访问的数据置换出去。

