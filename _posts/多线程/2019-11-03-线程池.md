---
layout:     post
title:      "线程池"
date:       2019-11-03 00:00:00
author:     "jiefang"
header-style: text
tags:
    - 多线程
    - JUC
---
# 线程池

## 概述
>ThreadPoolExecutor 是线程池的核心实现。线程的创建和终止需要很大的开销，线程池中预先提供了指定数量的可重用线程，所以使用线程池会节省系统资源，并且每个线程池都维护了一些基础的数据统计，方便线程的管理和监控。


## 参数
```
public ThreadPoolExecutor(int corePoolSize,
                              int maximumPoolSize,
                              long keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue<Runnable> workQueue,
                              ThreadFactory threadFactory,
                              RejectedExecutionHandler handler) 
```

参数名 | 作用
---|---
corePoolSize| 核心线程池大小
maximumPoolSize| 最大线程池大小
keepAliveTime| 线程池中超过corePoolSize数目的空闲线程最大存活时间；可以allowCoreThreadTimeOut(true)使得核心线程有效时间
TimeUnit |keepAliveTime时间单位
workQueue |阻塞任务队列
threadFactory |线程工厂
RejectedExecutionHandler| 当提交任务数超过maxmumPoolSize+workQueue之和时，任务会交给RejectedExecutionHandler来处理；

## 流程
![image](https://s2.ax1x.com/2019/11/02/KOSEPU.png)
- 当线程池小于corePoolSize时，新提交任务将创建一个新线程执行任务，即使此时线程池中存在空闲线程。
- 当线程池达到corePoolSize时，新提交任务将被放入workQueue中，等待线程池中任务调度执行
- 当workQueue已满，且maximumPoolSize>corePoolSize时，新提交任务会创建新线程执行任务
- 当提交任务数超过maximumPoolSize时，新提交任务由RejectedExecutionHandler处理
- 当线程池中超过corePoolSize线程，空闲时间达到keepAliveTime时，关闭空闲线程
- 当设置allowCoreThreadTimeOut(true)时，线程池中corePoolSize线程空闲时间达到keepAliveTime也将关闭

## 拒绝策略
- **AbortPolicy**:默认策略，在需要拒绝任务时抛出RejectedExecutionException；
- **DiscardPolicy**:也是丢弃任务，但是不抛出异常。 
- **DiscardOldestPolicy**:丢弃队列中等待时间最长的任务，并执行当前提交的任务，如果线程池已经关闭，任务将被丢弃。
- **CallerRunsPolicy**:直接在 execute 方法的调用线程中运行被拒绝的任务，如果线程池已经关闭，任务将被丢弃；

## 线程池状态
- **RUNNING**:可以接收新的任务和队列任务
- **SHUTDOWN**:不接收新的任务，但是会运行队列任务
- **STOP**:不接收新任务，也不会运行队列任务，并且中断正在运行的任务
- **TIDYING**:所有任务都已经终止，workerCount为0，当池状态为TIDYING时将会运行terminated()方法
- **TERMINATED**:terminated函数完成执行

![image](https://s2.ax1x.com/2019/11/02/KO9hCT.md.png)
