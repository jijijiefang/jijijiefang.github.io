---
layout:     post
title:      "01丨Hystrix简介"
date:       2019-12-04 15:17:22
author:     "jiefang"
header-style: text
tags:
    - Hystrix
---
# Hystrix简介
什么是Hystrix：
> Hystrix is a latency and fault tolerance library designed to isolate points of access to remote systems, services and 3rd party libraries, stop cascading failure and enable resilience in complex distributed systems where failure is inevitable.

翻译：
>在分布式环境中，不可避免地，许多服务依赖关系中的一些将失败。Hystrix是一个库，可通过添加延迟容差和容错逻辑来帮助您控制这些分布式服务之间的交互。Hystrix通过隔离服务之间的访问点、阻止跨它们的级联失败以及提供回退选项来实现这一点，所有这些都会提高系统的整体弹性

 


## Hystrix运行流程
![image](https://s2.ax1x.com/2019/10/11/uqJvvT.png)
流程说明:
- 1:每次调用创建一个新的HystrixCommand,把依赖调用封装在run()方法中.
- 2:执行execute()/queue做同步或异步调用.
- 3:判断是否使用缓存响应请求，若启用了缓存，且缓存可用，直接使用缓存响应请求。
- 4:判断熔断器(circuit-breaker)是否打开,如果打开跳到步骤8,进行降级策略,如果关闭进入步骤5.
- 5:判断线程池/队列/信号量是否跑满，如果跑满进入降级步骤8,否则继续后续步骤.
- 6:调用HystrixCommand的run方法.运行依赖逻辑
    - 6a:调用出错，进入步骤8.
    - 6b:依赖逻辑调用超时,进入步骤8.
    - 6c:返回成功调用结果.
- 7:计算熔断器状态,所有的运行状态(成功,失败,拒绝,超时)上报给熔断器，用于统计从而判断熔断器状态.
- 8:getFallback()降级逻辑.
  以下四种情况将触发getFallback调用：
    - (1):run()方法抛出非HystrixBadRequestException异常。
    - (2):run()方法调用超时
    - (3):熔断器开启拦截调用
    - (4):线程池/队列/信号量是否跑满
    - 8a:没有实现getFallback的Command将直接抛出异常
    - 8b:fallback降级逻辑调用成功直接返回
    - 8c:降级逻辑调用失败抛出异常
- 9:返回执行成功结果
## execute执行过程
![image](https://s2.ax1x.com/2019/10/15/K9HU3t.png)

调用的路径为execute() -> queue() -> toObservable() -> toBlocking() -> toFuture() -> get().核心的逻辑其实就在toObservable()中

## 熔断器
![image](https://s2.ax1x.com/2019/12/04/QldNSe.md.png)

## 线程池和信号量区别
![image](https://s2.ax1x.com/2019/12/04/QldJJO.md.png)

线程池的好处：

- 该应用程序完全可以不受失控的客户端库的威胁。即使某一个依赖的线程池已满也不会影响其他依赖的调用。
- 应用程序可以低风险的接受新的客户端库的数据，如果发生问题，它会与出问题的客户端库所隔离，不会影响其他依赖的任何内容。
- 当失败的客户端服务恢复时，线程池将会被清除，应用程序也会恢复，而不至于使得我们整个Tomcat容器出现故障。
- 如果一个客户端库的配置错误，线程池可以很快的感知这一错误（通过增加错误比例，延迟，超时，拒绝等），并可以在不影响应用程序的功能情况下来处理这些问题（可以通过动态配置来进行实时的改变）。
- 如果一个客户端服务的性能变差，可以通过改变线程池的指标（错误、延迟、超时、拒绝）来进行属性的调整，并且这些调整可以不影响其他的客户端请求。
- 除了隔离的优势之外，拥有专用的线程池可以提供内置的请求任务的并发性，可以在同步客户端上构建异步门面。

线程池的缺点：
- 每个 command 的执行都依托一个独立的线程，会进行排队，调度，还有上下文切换
- 增加额外系统开销