---
layout:     post
title:      "05丨数据分布算法"
date:       2019-11-20 21:48:46
author:     "jiefang"
header-style: text
tags:
    - Redis
    - 缓存
---
# 数据分布算法
**hash算法 -> 一致性hash算法（memcached） -> redis cluster，hash slot算法**
## hash算法
![image](https://s2.ax1x.com/2019/09/09/ntBQYT.png)

- 缓存服务器数量发生变化时，会引起缓存的雪崩，可能会引起整体系统压力过大而崩溃（大量缓存同一时间失效）
- 当缓存服务器数量发生变化时，几乎所有缓存的位置都会发生改变

## 一致性hash算法（自动缓存迁移）
![image](https://s2.ax1x.com/2019/09/09/nts27R.md.png)

### 一致性hash算法虚拟节点（自动负载均衡）
![image](https://s2.ax1x.com/2019/09/09/nt6Niq.png)

## redis cluster的hash slot算法
![image](https://s2.ax1x.com/2019/09/09/ntgkEd.png)

redis cluster有固定的16384个hash slot，对每个key计算CRC16值，然后对16384取模，可以获取key对应的hash slot

redis cluster中每个master都会持有部分slot，比如有3个master，那么可能每个master持有5000多个hash slot

hash slot让node的增加和移除很简单，增加一个master，就将其他master的hash slot移动部分过去，减少一个master，就将它的hash slot移动到其他master上去

移动hash slot的成本是非常低的

客户端的api，可以对指定的数据，让他们走同一个hash slot，通过hash tag来实现
这种结构很容易添加或者删除节点。如果增加一个节点 6，就需要从节点 1 ~ 5 获得部分槽分配到节点 6 上。如果想移除节点 1，需要将节点 1 中的槽移到节点 2 ~ 5 上，然后将没有任何槽的节点 1 从集群中移除即可。

　　由于从一个节点将哈希槽移动到另一个节点并不会停止服务，所以无论添加删除或者改变某个节点的哈希槽的数量都不会造成集群不可用的状态.

　　缓存的key hash结果是和slot绑定的，而不是和服务器节点绑定，所以节点的更替只需要迁移slot即可平滑过渡。