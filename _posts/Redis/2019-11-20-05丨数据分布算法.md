---
layout:     post
title:      "05丨数据分布算法"
date:       2019-11-20 21:48:46
author:     "jiefang"
header-style: text
tags:
    - Redis
    - 缓存
---
# 数据分布理论
分布式数据库首先要解决把整个数据集按照分区规则映射到多个节点的 问题，即把数据集划分到多个节点上，每个节点负责整体数据的一个子集。常见的分区规则有哈希分区和顺序分区两种。
![](https://s2.ax1x.com/2020/01/18/1pHFns.png)

## 节点取余分区
使用特定的数据，如Redis的键或用户ID，再根据节点数量N使用公式：hash（key）%N计算出哈希值，用来决定数据映射到哪一个节点上。这种方案存在一个问题：当节点数量变化时，如扩容或收缩节点，数据节点映射关系需要重新计算，会导致数据的重新迁移。
缓存服务器数量发生变化时，几乎所有缓存的位置都会发生改变，会引起缓存的雪崩，可能会引起整体系统压力过大而崩溃（大量缓存同一时间失效）。
![image](https://s2.ax1x.com/2019/09/09/ntBQYT.png)

优点是简单性，常用于数据库的分库分表规则，一般采用预分区的方式，提前根据数据量规划好分区数，比如划分为512或1024张表，保证可支撑未来一段时间的数据量，再根据负载情况将表迁移到其他数据库中。扩容时通常采用翻倍扩容，避免数据映射全部被打乱导致全量迁移的情况。
![](https://s2.ax1x.com/2020/01/18/1pHBDA.png)

## 一致性哈希分区
一致性哈希分区（Distributed Hash Table）实现思路是为系统中每个节点分配一个token，范围一般在0~232，这些token构成一个哈希环。数据读写 执行节点查找操作时，先根据key计算hash值，然后顺时针找到第一个大于等于该哈希值的token节点。

![](https://s2.ax1x.com/2020/01/18/1pbSV1.png)

一致性哈希分区存在几个问题：
- 加减节点会造成哈希环中部分数据无法命中，需要手动处理或者忽略这部分数据，因此一致性哈希常用于缓存场景；
- 当使用少量节点时，节点变化将大范围影响哈希环中数据映射，因此这种方式不适合少量数据节点的分布式方案；
- 普通的一致性哈希分区在增减节点时需要增加一倍或减去一半节点才能保证数据和负载的均衡；

### 一致性哈希分区虚拟节点（自动负载均衡）
![image](https://s2.ax1x.com/2019/09/09/nt6Niq.png)

## 虚拟槽分区
虚拟槽分区巧妙地使用了哈希空间，使用分散度良好的哈希函数把所有数据映射到一个固定范围的整数集合中，整数定义为槽（slot）。这个范围一般远远大于节点数，比如Redis Cluster槽范围是0~16383。槽是集群内数据管理和迁移的基本单位。采用大范围槽的主要目的是为了方便数据拆分和集 群扩展。每个节点会负责一定数量的槽。
### Redis数据分区
Redis Cluser采用虚拟槽分区，所有的键根据哈希函数映射到0~16383整 数槽内，计算公式：slot=CRC16（key）&16383。每一个节点负责维护一部 分槽以及槽所映射的键值数据。
![image](https://s2.ax1x.com/2019/09/09/ntgkEd.png)
Redis虚拟槽分区的特点：
- 解耦数据和节点之间的关系，简化了节点扩容和收缩难度；
- 节点自身维护槽的映射关系，不需要客户端或者代理服务维护槽分区元数据；
- 支持节点、槽、键之间的映射查询，用于数据路由、在线伸缩等场景；
Redis集群限制：
- key批量操作支持有限。如mset、mget，目前只支持具有相同slot值的 key执行批量操作；
- key事务操作支持有限。同理只支持多key在同一节点上的事务操 作，当多个key分布在不同的节点上时无法使用事务功能；
- key作为数据分区的最小粒度，因此不能将一个大的键值对象如 hash、list等映射到不同的节点；
- 不支持多数据库空间，单机下的Redis可以支持16个数据库，集群模式下只能使用一个数据库空间，即db0；
- 复制结构只支持一层，从节点只能复制主节点，不支持嵌套树状复制结构；