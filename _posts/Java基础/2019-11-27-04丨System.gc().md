---
layout:     post
title:      "Java基础-04丨System.gc()"
date:       2019-11-27 18:11:12
author:     "jiefang"
header-style: text
tags:
    - Java基础
    - JVM
---
# System.gc()
## 介绍
System.gc()，是JDK提供的触发Full GC的一种方式，会触发Full GC，其间会stop the world，对业务影响较大，一般情况下不会直接使用。
## 源码

### JDK实现
##### System.gc()
```
    public static void gc() {
        Runtime.getRuntime().gc();
    }
```
##### Runtime.gc()
```
    //java本地方法
    public native void gc();
```

### JVM实现

##### Runtime.c#Java_java_lang_Runtime_gc()
```
    JNIEXPORT void JNICALL
    Java_java_lang_Runtime_gc(JNIEnv *env, jobject this)
    {
        JVM_GC();
    }
```
##### jvm.cpp#JVM_GC()
```
    JVM_ENTRY_NO_ENV(void, JVM_GC(void))
      JVMWrapper("JVM_GC");
      //对应配置-XX:+DisableExplicitGC
      if (!DisableExplicitGC) {
        Universe::heap()->collect(GCCause::_java_lang_system_gc);
      }
    JVM_END
```
由heap()调用collect方法，具体是哪种heap，需要看gc算法，如常用的CMS GC的对应的heap是GenCollectedHeap。

##### genCollectedHeap.cpp#collect()
```
    void GenCollectedHeap::collect(GCCause::Cause cause) {
      //判断是否是并发Full GC
      if (should_do_concurrent_full_gc(cause)) {
    #if INCLUDE_ALL_GCS
        // mostly concurrent full collection
        //进行并发Full GC
        collect_mostly_concurrent(cause);
    #else  // INCLUDE_ALL_GCS
        ShouldNotReachHere();
    #endif // INCLUDE_ALL_GCS
      } else {
    #ifdef ASSERT
        if (cause == GCCause::_scavenge_alot) {
          // minor collection only
          collect(cause, 0);
        } else {
          // Stop-the-world full collection
          collect(cause, n_gens() - 1);
        }
    #else
        // Stop-the-world full collection
        collect(cause, n_gens() - 1);
    #endif
      }
    }
```
##### genCollectedHeap.cpp#should_do_concurrent_full_gc()
```
 //判断是不是进行一次并发Full GC
    bool GenCollectedHeap::should_do_concurrent_full_gc(GCCause::Cause cause) {
  return UseConcMarkSweepGC &&
         ((cause == GCCause::_gc_locker && GCLockerInvokesConcurrent) ||
          (cause == GCCause::_java_lang_system_gc && ExplicitGCInvokesConcurrent));
    }
```
如果当前是CMS垃圾收集器，且由System.gc()引起，且设置`-XX:ExplicitGCInvokesConcurrent`参数返回true。

涉及`-XX:ExplicitGCInvokesConcurrent`参数配置。

## 总结
System.gc()会触发Full GC，可以通过`-XX:+DisableExplicitGC`参数屏蔽`System.gc()`，在使用CMS GC的前提下，也可以使用`-XX:+ExplicitGCInvokesConcurrent`参数来进行并发Full GC，提升性能。